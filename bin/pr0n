#!/usr/bin/bash
###############
# Pr0n slideshow v1.2 - by wellspring
######
#
# KEYS
# ====
#   H       : Pause / Play
#   V       : Toggle fullscreen
#   S       : Save image
#   Left    : Go to the previous picture (NOTE: only within a same slideshow)
#   Right   : Go to the next picture
#   Q / Esc : Go to the next slideshow (in case it's a bad/weird one)
#
# SIGNALS
# =======
#   SIGUSR1 : Go to the next picture.
#   SIGUSR2 : Go to the previous picture.
#
######

#.config
window_width=480
window_height=360
window_margin=20

#.dependencies
archlinux_install() { has pacman && has pkgfile && sudo pacman -S $(pkgfile $1 | head -1); } # SEE: `install`
install() { archlinux_install $*; } # Usage: install <cmd> // Example: install grep
has() { hash $1 &>/dev/null; } # Usage: has <cmd> // Example: has ruby
require() { for cmd in $(echo $* | tr ',' ' '); do has $cmd || (echo -e "\e[31mError: this script needs the command \`${cmd}\`\e[0m"; install $cmd || exit 1); done; } # Usage: require <cmd [cmd [...]]> // Example: require curl, jq

#.functions
xh_picid_from_url() { for url in $*; do echo $url | grep -o '[0-9]*' | tail -1; done; }
xh_albumid_from_url() { for url in $*; do echo $url | grep -o '[0-9]*' | head -1; done; }
xh_slideshow_from_url() { for url in $*; do album=$(xh_albumid_from_url $url); curl "https://xhamster.com/photos/ajax.php?act=slide&gid=$album" | jq -r '.list[].big'; done; }

xh_extract_galleries_urls()  { grep -Eo "'http[^']*photos/(view|gallery)[^']*'" | sed 's/#.*$//' | tr -d "\\\\'" | uniq;  }
xh_extract_galleries_urls2() { grep -Eo '"http[^"]*photos/(view|gallery)[^"]*"' | sed 's/#.*$//' | tr -d "\\\\\"" | uniq; }
xh_extract_redir()           { curl -I "$1" | awk '/^Location:/{print $2}'; }

xh_featured_galleries()        { curl 'https://xhamster.com/videofeatured'                       | xh_extract_galleries_urls2; } # 9 results
xh_recentlyviewed_galleries()  { curl 'https://xhamster.com/photos/ajax.php?act=recent&id=1'     | xh_extract_galleries_urls; } # 15 results
xh_new_galleries()             { curl 'https://xhamster.com/photos'                              | xh_extract_galleries_urls; } # 46 results
xh_top_rated_galleries()       { curl 'https://xhamster.com/photos/rankings/alltime-rated.html'  | xh_extract_galleries_urls; } # 50 results
xh_topweek_rated_galleries()   { curl 'https://xhamster.com/photos/rankings/weekly-rated.html'   | xh_extract_galleries_urls; } # 50 results
xh_topmonth_rated_galleries()  { curl 'https://xhamster.com/photos/rankings/monthly-rated.html'  | xh_extract_galleries_urls; } # 50 results
xh_top_viewed_galleries()      { curl 'https://xhamster.com/photos/rankings/alltime-viewed.html' | xh_extract_galleries_urls; } # 50 results
xh_topweek_viewed_galleries()  { curl 'https://xhamster.com/photos/rankings/weekly-viewed.html'  | xh_extract_galleries_urls; } # 50 results
xh_topmonth_viewed_galleries() { curl 'https://xhamster.com/photos/rankings/monthly-viewed.html' | xh_extract_galleries_urls; } # [FAIL]
xh_category_galleries()        { category=$1; curl "https://xhamster.com/photos/niches/new-$category-1.html" | xh_extract_galleries_urls; } # 46 results
xh_user_galleries()            { username=$1; curl "https://xhamster.com/user/photo/$username/new-1.html"    | xh_extract_galleries_urls; } # 2 results
xh_search_galleries()          { search=$(echo $1 | tr ' ' '+'); curl "https://xhamster.com/search.php?from=&new=&q=$search&qcat=pictures" | xh_extract_galleries_urls; } # 28 results

xh_get_latest_slideshow() { xh_slideshow_from_url $(xh_recentlyviewed_galleries | head -n1); }
xh_get_random_latest_slideshow() { xh_slideshow_from_url $(xh_recentlyviewed_galleries | shuf -n1); }
xh_get_random_slideshow() { xh_slideshow_from_url $(xh_extract_redir 'https://xhamster.com/random.php?type=gallery'); }

xh_size_and_position() { read screen_width screen_height <<<$(xrandr | awk '/\*\+$/{print $1}' | tr 'x' ' '); echo "${window_width}x${window_height}+$(($screen_width-$window_width-$window_margin))+$(($screen_height-$window_height-2*$window_margin))"; }
xh_download_and_display_new_slideshow() { echo " [+] Downloading images..."; wget -nv -P demo/slideshow $(xh_get_latest_slideshow) | sed -E 's/\S+ \S+ /   > /'; echo " [+] Starting slideshow..."; feh --title 'pr0n slideshow' -g $(xh_size_and_position) -B black --cycle-once -xzYND2 demo/slideshow/; echo " [+] Done."; }
xh_display_new_slideshow() { feh --title 'pr0n slideshow' -g $(xh_size_and_position) -B black --cycle-once -xzYND2 $(xh_get_latest_slideshow); }
xh_start_slideshow() { while true; do xh_display_new_slideshow; done; }

#.start
require 'bash' 'grep' 'head' 'tail' 'tr' 'uniq' 'awk' 'sed' 'curl' 'jq' 'feh'
xh_start_slideshow


